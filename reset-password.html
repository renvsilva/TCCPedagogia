<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Redefinir Senha ‚Äî Raquel Maciel Reis</title>
    <link rel="stylesheet" href="main.css">
    <link rel="icon" type="image/x-icon" href="Assets/Logo.jpg">
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="firebase.js"></script> 
    
    <style>
        /* Estilos adicionais para a p√°gina de redefini√ß√£o */
        .toggle-pass {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <main class="container py-8">
        <div class="panel" style="max-width: 400px; margin: 50px auto;">
            <form id="password-reset-form" class="form">
                <h2>Redefini√ß√£o de Senha</h2>
                <p id="reset-msg" class="muted">Digite e confirme sua nova senha.</p>
                
                <label>Nova Senha</label>
                <div style="position:relative">
                    <input id="new-pass" type="password" class="input" required minlength="6">
                    <span class="toggle-pass" onclick="togglePass('new-pass',this)">üëÅ</span>
                </div>
                
                <ul id="password-criteria-reset" class="password-criteria">
                    <li id="rule-length" class="criteria-item">M√≠nimo 8 caracteres</li>
                    <li id="rule-upper" class="criteria-item">Letra Mai√∫scula</li>
                    <li id="rule-lower" class="criteria-item">Letra Min√∫scula</li>
                    <li id="rule-number" class="criteria-item">N√∫mero</li>
                </ul>

                <label>Confirme a Nova Senha</label>
                <div style="position:relative">
                    <input id="confirm-pass" type="password" class="input" required minlength="6">
                    <span class="toggle-pass" onclick="togglePass('confirm-pass',this)">üëÅ</span>
                </div>

                <button type="submit" class="btn btn-primary mt-3">Redefinir Senha</button>
                <a href="index.html" class="btn btn-ghost mt-2">Voltar para o In√≠cio</a>
            </form>
        </div>
    </main>
    
    <script>
        // Fun√ß√£o para mostrar/ocultar senha (replicada do index.html)
        function togglePass(inputId, el) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                el.textContent = "üï≥";
            } else {
                input.type = "password";
                el.textContent = "üëÅ";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('password-reset-form');
            const newPassInput = document.getElementById('new-pass');
            const confirmPassInput = document.getElementById('confirm-pass');
            const submitButton = form.querySelector('button[type="submit"]');
            const msgEl = document.getElementById('reset-msg');
            
            // Elementos da lista de crit√©rios
            const ruleLength = document.getElementById('rule-length');
            const ruleUpper = document.getElementById('rule-upper');
            const ruleLower = document.getElementById('rule-lower');
            const ruleNumber = document.getElementById('rule-number');


            // ----------------------------------------------------------------------
            // L√≥gica de Verifica√ß√£o de For√ßa da Senha
            // ----------------------------------------------------------------------
            function checkPasswordStrength() {
                const val = newPassInput.value;
                
                // Regex de valida√ß√£o (m√≠nimo de 8 caracteres, Mai√∫scula, Min√∫scula, N√∫mero)
                const hasLength = val.length >= 8; 
                const hasUpper = /[A-Z]/.test(val);
                const hasLower = /[a-z]/.test(val);
                const hasNumber = /[0-9]/.test(val);

                // Fun√ß√£o auxiliar para atualizar visual
                function updateClass(element, isValid) {
                    if (element) {
                        if (isValid) {
                            element.classList.add('valid');
                        } else {
                            element.classList.remove('valid');
                        }
                    }
                }

                // Atualiza a UI
                updateClass(ruleLength, hasLength);
                updateClass(ruleUpper, hasUpper);
                updateClass(ruleLower, hasLower);
                updateClass(ruleNumber, hasNumber);

                // Bloqueia ou libera o bot√£o de envio
                const isStrong = hasLength && hasUpper && hasLower && hasNumber;
                if (submitButton) {
                    submitButton.disabled = !isStrong;
                }
                
                return isStrong; // Retorna o status de for√ßa
            }

            if (newPassInput && submitButton) {
                // Garante que o bot√£o esteja desabilitado por padr√£o
                submitButton.disabled = true;

                // Ouve o que o usu√°rio digita
                newPassInput.addEventListener('input', checkPasswordStrength);
            }
            // ----------------------------------------------------------------------
            

            // 1. Captura o par√¢metro 'oobCode' da URL
            const urlParams = new URLSearchParams(window.location.search);
            const oobCode = urlParams.get('oobCode');

            if (!oobCode) {
                msgEl.textContent = '‚ùå Erro: C√≥digo de redefini√ß√£o de senha n√£o encontrado.';
                msgEl.style.color = '#dc3545';
                form.style.display = 'none'; // Esconde o formul√°rio
                return;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = newPassInput.value;
                const confirmPassword = confirmPassInput.value;
                
                if (newPassword !== confirmPassword) {
                    msgEl.textContent = '‚ùå As senhas n√£o coincidem!';
                    msgEl.style.color = '#dc3545';
                    return;
                }

                // NOVO: Verifica a for√ßa da senha antes de tentar redefinir
                if (!checkPasswordStrength()) {
                    msgEl.textContent = '‚ùå A senha n√£o atende a todos os crit√©rios de seguran√ßa (m√≠nimo 8 caracteres, mai√∫scula, min√∫scula e n√∫mero).';
                    msgEl.style.color = '#dc3545';
                    return;
                }

                // Desabilita o bot√£o para evitar cliques m√∫ltiplos
                submitButton.disabled = true;
                submitButton.textContent = 'Redefinindo...';
                msgEl.textContent = ''; // Limpa mensagens anteriores

                try {
                    // 2. Chama a fun√ß√£o do Firebase para confirmar a redefini√ß√£o
                    await window.auth.confirmPasswordReset(oobCode, newPassword);
                    
                    msgEl.textContent = '‚úÖ Senha redefinida com sucesso! Redirecionando...';
                    msgEl.style.color = '#198754';
                    
                    // Redireciona o usu√°rio ap√≥s alguns segundos
                    setTimeout(() => {
                        window.location.href = 'index.html'; 
                    }, 3000);

                } catch (error) {
                    console.error('Erro ao redefinir a senha:', error);
                    let errorMessage = 'Erro ao redefinir a senha. O link pode ter expirado.';
                    
                    if (error.code === 'auth/invalid-action-code') {
                         errorMessage = 'Link de redefini√ß√£o inv√°lido ou expirado.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'A senha √© muito fraca. Escolha uma mais segura.';
                    }
                    
                    msgEl.textContent = `‚ùå ${errorMessage}`;
                    msgEl.style.color = '#dc3545';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Redefinir Senha';
                }
            });
        });
    </script>
</body>

</html>