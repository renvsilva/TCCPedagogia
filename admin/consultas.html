<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda ‚Äî Admin</title>

  <link rel="stylesheet" href="../main.css">
  <link rel="stylesheet" href="../main.css">
  <link rel="icon" type="image/x-icon" href="Assets/Logo.jpg">

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-storage-compat.js"></script>


  <script src="../firebase.js"></script>

  <script src="admin.js"></script>
</head>

<body class="hidden">
  <div class="admin-layout">
    <aside class="sidebar">
      <h2>Admin</h2>
      <nav>
        <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
        <a href="pacientes.html" class="nav-link">üë• Pacientes</a>
        <a href="agenda.html" class="nav-link">üóì Agenda</a>
        <a href="configs.html" class="nav-link">‚öô Configura√ß√µes</a>
        <a href="../index.html" class="nav-link"> Retornar</a>
      </nav>
    </aside>

    <main class="container">
      <h1>Agenda</h1>
      <p class="muted">Visualize, edite e adicione consultas.</p>

      <div class="calendar-header mt-3">
        <button id="prevMonth" class="btn btn-ghost">‚¨Ö M√™s anterior</button>
        <h2 id="monthYear"></h2>
        <button id="nextMonth" class="btn btn-ghost">M√™s seguinte ‚û°</button>
      </div>

      <div class="calendar mt-3" id="calendar"></div>
    </main>
  </div>

  <div class="modal" id="eventModal">
    <div class="modal-content panel">
      <h2 id="modalDate"></h2>
      <ul id="eventList"></ul>

      <h3 class="mt-3">‚ûï Nova Consulta</h3>
      <form id="eventForm">
        <select id="pacienteSelect" class="input mt-1" required>
          <option value="" disabled selected>Selecione um Paciente</option>
        </select>
        <input type="time" id="hora" class="input mt-1" required>
        <button type="submit" class="btn btn-primary mt-2">Salvar</button>
      </form>
      <button id="closeModal" class="btn btn-ghost mt-2">Fechar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
      onSnapshot,
      getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDvMSEl-3Tj5IvC5cs09DY8xZuUve4NyOU",
      authDomain: "tccneuropsicopedagoga.firebaseapp.com",
      projectId: "tccneuropsicopedagoga",
      storageBucket: "tccneuropsicopedagoga.firebasestorage.app",
      messagingSenderId: "189432898003",
      appId: "1:189432898003:web:aab9ddd5eba744a6350f26",
      measurementId: "G-XR0LJT1KB8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const calendar = document.getElementById("calendar");
    const monthYear = document.getElementById("monthYear");
    const modal = document.getElementById("eventModal");
    const modalDate = document.getElementById("modalDate");
    const eventList = document.getElementById("eventList");
    const eventForm = document.getElementById("eventForm");
    const pacienteSelect = document.getElementById("pacienteSelect"); // Novo seletor
    const horaInput = document.getElementById("hora");

    let currentDate = new Date();
    let selectedDate = null;
    let patientsList = []; // Array para armazenar pacientes (ID e Nome)

    // FUN√á√ÉO CORRIGIDA: Carregar Pacientes
    async function loadPatients() {
        try {
            // 1. Refer√™ncia √† cole√ß√£o 'pacientes'
            const patientsRef = collection(db, "pacientes");
            
            // 2. Cria a query: busca na cole√ß√£o 'pacientes' onde o status √© 'Ativo'
            const q = query(patientsRef, where("status", "==", "Ativo")); 

            // 3. Executa a query usando getDocs (Sintaxe Modular)
            const patientsSnapshot = await getDocs(q); 

            patientsList = patientsSnapshot.docs.map(doc => ({
                id: doc.id,
                name: doc.data().nome || "Paciente sem nome"
            }));

            // Preenche o campo de sele√ß√£o (select)
            pacienteSelect.innerHTML = '<option value="" disabled selected>Selecione um Paciente</option>';
            patientsList.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name; // ‚¨ÖÔ∏è CORRE√á√ÉO: Usando p.name, conforme definido no mapeamento
                pacienteSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Erro ao carregar lista de pacientes:", error);
            // Pode adicionar uma mensagem de erro na interface aqui
        }
    }
    // ----------------------------------------------------------------------


    function formatDate(year, month, day) {
      return `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      let firstDay = new Date(Date.UTC(year, month, 1)).getUTCDay();
      if (firstDay === 0) firstDay = 7;

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      monthYear.textContent = currentDate.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });

      calendar.innerHTML = "";

      for (let i = 1; i < firstDay; i++) {
        calendar.innerHTML += `<div></div>`;
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const fullDate = formatDate(year, month, d);
        const today = new Date().toISOString().split("T")[0] === fullDate;

        const div = document.createElement("div");
        div.classList.add("day");
        if (today) div.classList.add("today");
        div.dataset.date = fullDate;
        div.innerHTML = `<div class="day-number">${d}</div><div class="events"></div>`;

        div.addEventListener("click", () => openModal(fullDate));
        calendar.appendChild(div);

        loadEvents(fullDate, div.querySelector(".events"));
      }
    }

    function openModal(date) {
      selectedDate = date;
      modal.classList.add("active");
      modalDate.textContent = new Date(date + "T00:00:00").toLocaleDateString("pt-BR");
      loadEvents(date, eventList, true);
    }

    function closeModal() {
      modal.classList.remove("active");
      eventList.innerHTML = "";
      eventForm.reset();
    }

    function loadEvents(date, container, detailed = false) {
      container.innerHTML = "";
      const q = query(collection(db, "consultas"), where("data", "==", date));
      onSnapshot(q, snapshot => {
        container.innerHTML = "";
        if (snapshot.empty && detailed) {
          container.innerHTML = `<li class="muted">Nenhuma consulta</li>`;
        }
        snapshot.forEach(docSnap => {
          const c = docSnap.data();
          // Usa 'patientName' para novos agendamentos e 'paciente' como fallback para agendamentos antigos
          const patientDisplay = c.patientName || c.paciente;

          if (detailed) {
            container.innerHTML += `
              <li>
                ${c.hora} - ${patientDisplay}
                <span class="event-actions">
                  <button class="btn btn-ghost" data-edit="${docSnap.id}" data-hora="${c.hora}" data-paciente="${patientDisplay}">‚úè</button>
                  <button class="btn btn-ghost" data-del="${docSnap.id}">üóë</button>
                </span>
              </li>`;
          } else {
            const div = document.createElement("div");
            div.classList.add("event");
            div.textContent = `${c.hora} ${patientDisplay}`;
            container.appendChild(div);
          }
        });

        if (detailed) {
          container.querySelectorAll("button[data-edit]").forEach(btn => {
            btn.addEventListener("click", async e => {
              const id = e.target.dataset.edit;
              const pacienteAtual = e.target.dataset.paciente;
              const horaAtual = e.target.dataset.hora;

              const novoPacienteNome = prompt("Nome do paciente:", pacienteAtual);
              const novaHora = prompt("Hora:", horaAtual);

              if (novoPacienteNome && novaHora) {
                // Ao editar por prompt, a refer√™ncia ao ID do paciente √© perdida, 
                // por isso atualizamos apenas o nome de exibi√ß√£o (patientName) e hora.
                await updateDoc(doc(db, "consultas", id), {
                  patientName: novoPacienteNome,
                  hora: novaHora
                });
              }
            });
          });

          container.querySelectorAll("button[data-del]").forEach(btn => {
            btn.addEventListener("click", async e => {
              const id = e.target.dataset.del;
              if (confirm("Excluir esta consulta?")) {
                await deleteDoc(doc(db, "consultas", id));
              }
            });
          });
        }
      });
    }

    document.getElementById("prevMonth").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });
    document.getElementById("nextMonth").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });
    document.getElementById("closeModal").addEventListener("click", closeModal);

    // ALTERA√á√ÉO: L√≥gica de submiss√£o do formul√°rio para salvar patientId e patientName
    eventForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!selectedDate) return;

      const selectedPatientId = pacienteSelect.value;
      // Encontra o nome completo na lista de pacientes carregada
      const selectedPatient = patientsList.find(p => p.id === selectedPatientId);
      const patientName = selectedPatient ? selectedPatient.name : 'Paciente Desconhecido';

      await addDoc(collection(db, "consultas"), {
        patientId: selectedPatientId,   // ID do documento do paciente
        patientName: patientName,       // Nome do paciente para exibi√ß√£o
        hora: horaInput.value,
        data: selectedDate
      });
      eventForm.reset();
    });

    renderCalendar();
    loadPatients(); // Chama a fun√ß√£o para carregar os pacientes
  </script>
</body>

</html> 