<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configura√ß√µes ‚Äî Admin</title>
    <link rel="stylesheet" href="../main.css" />

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-storage-compat.js"></script>

    <script src="../firebase.js"></script>
    <script src="admin.js"></script>
</head>

<body class="hidden">
    <div class="admin-layout">
        <!-- SIDEBAR -->
        <aside class="sidebar panel">
            <h2>Admin</h2>
            <nav>
                <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
                <a href="pacientes.html" class="nav-link">üë• Pacientes</a>
                <a href="consultas.html" class="nav-link">üìÖ Agenda</a>
                <a href="configs.html" class="nav-link">‚öôÔ∏è Configura√ß√µes</a>
                <a href="../index.html" class="nav-link"> Retornar</a>
            </nav>
        </aside>

        <!-- CONTE√öDO PRINCIPAL -->
        <main class="container">
            <h1>‚öôÔ∏è Configura√ß√µes</h1>
            <p class="muted">Gerencie permiss√µes e administradores do sistema.</p>

            <!-- FORMUL√ÅRIO -->
            <section class="panel mt-4">
                <h2>‚ûï Adicionar Administrador</h2>
                <div class="form mt-3">
                    <label for="email">E-mail do usu√°rio:</label>
                    <input type="email" id="email" class="input" required />
                    <button type="button" id="promoteBtn" class="btn btn-primary mt-3">
                        Promover a Admin
                    </button>
                </div>
            </section>

            <!-- LISTAGEM -->
            <section class="panel mt-6">
                <h2>üë• Usu√°rios do Sistema</h2>
                <p class="section-sub">Veja todos os usu√°rios e altere permiss√µes de administrador em tempo real.</p>

                <div class="table-responsive mt-3">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody">
                            <tr>
                                <td colspan="4" style="text-align:center;">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const usersBody = document.getElementById("usersBody");
            const promoteBtn = document.getElementById("promoteBtn");
            const emailInput = document.getElementById("email");

            // ---- FUN√á√ïES DE PROMOVER / REMOVER ----
            async function setAdmin(uid, status) {
                try {
                    // Acesso direto ao db pois a p√°gina s√≥ roda se o acesso admin foi validado.
                    await db.collection("users").doc(uid).update({ isAdmin: status });
                    alert(status ? "‚úÖ Usu√°rio promovido a admin!" : "‚ùå Admin removido!");
                    // O renderUsers ser√° chamado automaticamente pelo snapshot
                } catch (err) {
                    console.error("Erro ao atualizar admin:", err);
                    alert("Erro ao atualizar administrador.");
                }
            }

            // ---- LISTAGEM DE USU√ÅRIOS EM TEMPO REAL ----
            function renderUsers(users) {
                usersBody.innerHTML = "";

                if (users.length === 0) {
                    usersBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Nenhum usu√°rio encontrado</td></tr>`;
                    return;
                }

                users.forEach((doc) => {
                    const u = doc.data();
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                    <td>${u.name || "-"}</td>
                    <td>${u.email || "-"}</td>
                    <td>
                        <span class="badge" style="background:${u.isAdmin ? "var(--brand-2)" : "var(--muted)"}">
                            ${u.isAdmin ? "Admin" : "Usu√°rio"}
                        </span>
                    </td>
                    <td>
                        ${u.isAdmin
                            ? `<button class="btn btn-ghost" data-remove="${doc.id}">‚ùå Remover Admin</button>`
                            : `<button class="btn btn-primary" data-promote="${doc.id}">‚ûï Tornar Admin</button>`}
                    </td>
                `;

                    usersBody.appendChild(tr);
                });

                // Eventos de a√ß√£o (reatribuir a cada renderiza√ß√£o do DOM)
                document.querySelectorAll("[data-promote]").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        setAdmin(btn.dataset.promote, true);
                    });
                });

                document.querySelectorAll("[data-remove]").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        setAdmin(btn.dataset.remove, false);
                    });
                });
            }

            // Snapshot em tempo real
            if (db) {
                db.collection("users").onSnapshot((snap) => {
                    console.log("Snapshot de usu√°rios atualizado. Total:", snap.size);
                    renderUsers(snap.docs);
                });
            }

            // L√≥gica do bot√£o "Promover a Admin" (Adicionar Administrador)
            if (promoteBtn) {
                promoteBtn.addEventListener("click", async () => {
                    const email = emailInput.value;
                    if (!email) {
                        alert("Por favor, insira um e-mail.");
                        return;
                    }

                    try {
                        // Busca o UID do usu√°rio com base no e-mail
                        const querySnapshot = await db.collection("users").where("email", "==", email).limit(1).get();

                        if (querySnapshot.empty) {
                            alert("Erro: Usu√°rio n√£o encontrado no Firestore. Pe√ßa para o usu√°rio fazer login pelo menos uma vez.");
                            return;
                        }

                        const uid = querySnapshot.docs[0].id;
                        await setAdmin(uid, true);
                        emailInput.value = "";

                    } catch (error) {
                        console.error("Erro ao tentar promover:", error);
                        alert("Erro ao tentar promover. Verifique o console.");
                    }
                });
            }
        });
    </script>

</html>