<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meu Perfil ‚Äî Raquel Maciel Reis</title>

    <link rel="stylesheet" href="main.css">
    <link rel="icon" type="image/x-icon" href="Assets/Logo.jpg">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="nav" aria-label="Navega√ß√£o principal">
        <div class="container nav-inner">
            <a class="brand" href="index.html" aria-label="P√°gina inicial">
                <span class="logo" aria-hidden="true"><img src="Assets/Logo.jpg" class="logoimage" alt="Logo"></span>
                <span>
                    <h1>Raquel Maciel Reis</h1>
                    <small>Neuropsicopedagoga Cl√≠nica e Institucional</small>
                </span>
            </a>

            <div class="nav-menu" role="navigation">
                <a href="index.html#sobre">Sobre</a>
                <a href="index.html#servicos">Servi√ßos</a>
                <a href="index.html#processo">Funcionamento</a>
                <a href="index.html#faq">D√∫vidas</a>
                <a href="index.html#contato">Contato</a>
                <a id="admin-link" href="admin/dashboard.html" class="hidden">Admin</a>
                <div id="user-profile-container" class="hidden">
                    <img id="user-photo" src="Assets/Placeholder.jpg" alt="Foto do usu√°rio" />
                    <span id="user-name-nav">Usu√°rio</span>
                    <div id="profile-dropdown" class="hidden">
                        <a href="profile.html">Meu Perfil</a>
                        <a href="#" onclick="window.logoutUser(); return false;">Sair</a>
                    </div>
                </div>
                <a id="login-btn" class="cta" href="#">Login</a>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 40px; padding-bottom: 40px;">
        <section class="panel" style="max-width: 600px; margin: auto;">
            <h1>Meu Perfil</h1>
            <p class="muted">Atualize suas informa√ß√µes pessoais e de seguran√ßa.</p>

            <form id="perfilForm" class="form mt-4">
                <div class="profile-photo-section">
                    <img id="userPhotoPreview" src="Assets/Placeholder.jpg" alt="Pr√©via da foto de perfil">
                    <input type="file" id="photoUpload" accept="image/*">
                    <button type="button" id="uploadBtn" class="btn btn-ghost">Trocar Foto</button>
                </div>

                <label for="userName">Nome Completo:</label>
                <input type="text" id="userName" class="input" required>

                <label for="userEmail">E-mail:</label>
                <input type="email" id="userEmail" class="input" required>

                <hr style="border-color: var(--border); margin: 20px 0;">

                <p class="muted">Para alterar a senha, preencha os campos abaixo.</p>

                <label for="newPassword">Nova Senha:</label>
                <div style="position:relative">
                    <input type="password" id="newPassword" class="input" minlength="6"
                        placeholder="Deixe em branco para n√£o alterar">
                    <span class="toggle-pass" onclick="togglePass('newPassword',this)">üëÅ</span>
                </div>

                <div id="password-strength-meter" class="mt-2">
                    <div class="strength-bar-container">
                        <div id="strength-bar" class="strength-bar"></div>
                    </div>
                    <ul id="password-criteria-list" class="password-criteria">
                        <li id="rule-length" class="criteria-item">M√≠n. 6 caracteres</li>
                        <li id="rule-lower" class="criteria-item">Letra min√∫scula</li>
                        <li id="rule-upper" class="criteria-item">Letra mai√∫scula</li>
                        <li id="rule-number" class="criteria-item">N√∫mero</li>
                    </ul>
                </div>
                <label for="confirmPassword">Confirmar Nova Senha:</label>
                <div style="position:relative">
                    <input type="password" id="confirmPassword" class="input" minlength="6">
                    <span class="toggle-pass" onclick="togglePass('confirmPassword',this)">üëÅ</span>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-storage-compat.js"></script>
    <script src="firebase.js"></script>

    <script>
        function togglePass(inputId, el) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                el.textContent = "üï≥"; // Olho aberto
            } else {
                input.type = "password";
                el.textContent = "üëÅ"; // Olho fechado
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const perfilForm = document.getElementById('perfilForm');
            const userNameInput = document.getElementById('userName');
            const userEmailInput = document.getElementById('userEmail');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const userPhotoPreview = document.getElementById('userPhotoPreview');
            const photoUploadInput = document.getElementById('photoUpload');
            const uploadBtn = document.getElementById('uploadBtn');

            // Vari√°veis para o medidor de for√ßa (Novas)
    const strengthBar = document.getElementById('strength-bar');
    const ruleLength = document.getElementById('rule-length');
    const ruleLower = document.getElementById('rule-lower');
    const ruleUpper = document.getElementById('rule-upper');
    const ruleNumber = document.getElementById('rule-number');

    /**
     * Verifica a for√ßa da senha e atualiza o medidor visual.
     * Baseado na l√≥gica de 4 crit√©rios do firebase.js: 6+ chars, min√∫scula, mai√∫scula e n√∫mero.
     * @param {string} password A senha a ser verificada.
     * @returns {number} O score de for√ßa (0 a 4).
     */
    function checkPasswordStrength(password) {
        let score = 0;
        const checks = {
            length: password.length >= 6,
            lower: /[a-z]/.test(password),
            upper: /[A-Z]/.test(password),
            number: /[0-9]/.test(password)
        };

        // Atualiza o score e os itens da lista
        if (checks.length) { score++; ruleLength.classList.add('valid'); } else { ruleLength.classList.remove('valid'); }
        if (checks.lower) { score++; ruleLower.classList.add('valid'); } else { ruleLower.classList.remove('valid'); }
        if (checks.upper) { score++; ruleUpper.classList.add('valid'); } else { ruleUpper.classList.remove('valid'); }
        if (checks.number) { score++; ruleNumber.classList.add('valid'); } else { ruleNumber.classList.remove('valid'); }

        // Atualiza a barra de for√ßa (progress bar)
        let width = (score / 4) * 100; // 4 crit√©rios = 100%
        strengthBar.style.width = `${width}%`;

        strengthBar.classList.remove('weak', 'medium', 'strong');
        if (password.length > 0) {
            if (score < 3) {
                strengthBar.classList.add('weak');
            } else if (score === 3) {
                strengthBar.classList.add('medium');
            } else if (score === 4) {
                strengthBar.classList.add('strong');
            }
        } else {
            strengthBar.style.width = '0%';
        }

        return score;
    }

    // Adiciona o listener para atualizar a for√ßa da senha em tempo real
    newPasswordInput.addEventListener('input', (e) => {
        checkPasswordStrength(e.target.value);
    });
    
    // --- Modifica√ß√£o no evento de submit do formul√°rio ---
    perfilForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const user = firebase.auth().currentUser;
        if (!user) {
            alert('Voc√™ precisa estar logado para salvar as altera√ß√µes.');
            return;
        }

        submitButton.disabled = true;
        submitButton.textContent = 'Salvando...';

        try {
            // 1. Atualiza nome e email no Firebase Auth e Firestore (C√≥digo Existente)
            const userName = document.getElementById('userName').value;
            const userEmail = document.getElementById('userEmail').value;

            const updates = {};
            if (userName !== user.displayName) {
                await user.updateProfile({ displayName: userName });
                updates.name = userName;
            }
            // N√£o permitimos mudan√ßa de email aqui para simplificar o exemplo, mas voc√™
            // pode implementar a mudan√ßa de email se necess√°rio (envolvendo reautentica√ß√£o).
            // if (userEmail !== user.email) { /* ... l√≥gica de mudan√ßa de email ... */ }

            // 2. Valida√ß√£o da senha, se preenchida (Adicionando a valida√ß√£o de for√ßa)
            if (newPasswordInput.value.trim() !== '') {
                // VERIFICAR A FOR√áA DA SENHA (BASEADO NA L√ìGICA DO firebase.js)
                const score = checkPasswordStrength(newPasswordInput.value);
                // Exigir for√ßa total (score 4) para a altera√ß√£o
                if (score < 4) { 
                    throw new Error("A nova senha √© muito fraca. Por favor, inclua no m√≠nimo 6 caracteres, letra mai√∫scula, min√∫scula e n√∫mero."); 
                }
                
                if (newPasswordInput.value !== confirmPasswordInput.value) {
                    throw new Error("As novas senhas n√£o coincidem!");
                }
                await user.updatePassword(newPasswordInput.value);
            }

            // 4. Salva as informa√ß√µes atualizadas no Firestore (C√≥digo Existente)
            if (Object.keys(updates).length > 0) {
                await firebase.firestore().collection('users').doc(user.uid).set(updates, { merge: true });
            }

            alert('Perfil atualizado com sucesso!');
            setTimeout(() => window.location.reload(), 1000);

        } catch (error) {
            // Se o erro for de senha fraca do Firebase, trata com a mensagem customizada
            if (error.code && error.code === 'auth/weak-password') {
                 alert('Erro: A nova senha √© muito fraca. Por favor, inclua letra mai√∫scula, min√∫scula, n√∫mero e tenha no m√≠nimo 6 caracteres.');
            } else {
                 alert(`Erro: ${error.message}`);
            }
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Salvar Altera√ß√µes';
            // Limpa os campos de senha ap√≥s a tentativa de salvamento
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            checkPasswordStrength(''); // Limpa o medidor de for√ßa
        }
    });

            // L√≥gica de upload de foto e redimensionamento (mantida)
            uploadBtn.addEventListener('click', () => photoUploadInput.click());

            function resizeAndConvertImage(file, maxWidth, maxHeight, quality) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = (error) => reject(error);
                    };
                    reader.onerror = (error) => reject(error);
                });
            }

            photoUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        alert('Por favor, selecione um arquivo de imagem.');
                        photoUploadInput.value = '';
                        return;
                    }
                    try {
                        const resizedBase64 = await resizeAndConvertImage(file, 400, 400, 0.8);
                        userPhotoPreview.src = resizedBase64;
                    } catch (error) {
                        console.error('Erro ao processar imagem:', error);
                        alert('Ocorreu um erro ao carregar a imagem.');
                        photoUploadInput.value = '';
                    }
                }
            });

            // Carrega as informa√ß√µes do usu√°rio do Firestore assim que o estado de autentica√ß√£o estiver pronto
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            userNameInput.value = userData.name || user.displayName || '';
                            userEmailInput.value = userData.email || user.email || '';
                            userPhotoPreview.src = userData.photoURL || user.photoURL || 'Assets/Placeholder.jpg';
                        } else {
                            userNameInput.value = user.displayName || '';
                            userEmailInput.value = user.email || '';
                            userPhotoPreview.src = user.photoURL || 'Assets/Placeholder.jpg';
                        }
                    } catch (error) {
                        console.error("Erro ao carregar dados do usu√°rio:", error);
                        userNameInput.value = user.displayName || '';
                        userEmailInput.value = user.email || '';
                        userPhotoPreview.src = user.photoURL || 'Assets/Placeholder.jpg';
                    }
                } else {
                    alert("Voc√™ precisa estar logado para acessar esta p√°gina.");
                    window.location.href = 'index.html';
                }
            });

            // L√≥gica de submit do formul√°rio (agora mais robusta)
            perfilForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = firebase.auth().currentUser;
                if (!user) return;

                const submitButton = perfilForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Salvando...';

                try {
                    const updates = {};
                    const fileToUpload = photoUploadInput.files[0];

                    // 1. L√≥gica de atualiza√ß√£o da foto
                    if (fileToUpload) {
                        const newPhotoUrl = await uploadUserPhoto(user.uid, fileToUpload);
                        // Adiciona o novo URL da foto ao objeto de atualiza√ß√µes para o Firestore
                        updates.photoURL = newPhotoUrl;
                        // Atualiza tamb√©m no Firebase Authentication
                        await user.updateProfile({ photoURL: newPhotoUrl });
                    }

                    // 2. L√≥gica de atualiza√ß√£o de nome e email
                    if (userNameInput.value !== (user.displayName || '')) {
                        updates.name = userNameInput.value;
                        await user.updateProfile({ displayName: userNameInput.value });
                    }

                    if (userEmailInput.value !== (user.email || '')) {
                        updates.email = userEmailInput.value;
                        await user.updateEmail(userEmailInput.value);
                    }

                    // 3. L√≥gica de atualiza√ß√£o da senha (separada das outras)
                    if (newPasswordInput.value) {
                        if (newPasswordInput.value !== confirmPasswordInput.value) {
                            throw new Error("As novas senhas n√£o coincidem!");
                        }
                        await user.updatePassword(newPasswordInput.value);
                    }

                    // 4. Salva as informa√ß√µes atualizadas no Firestore (apenas se houver algo para salvar)
                    if (Object.keys(updates).length > 0) {
                        await firebase.firestore().collection('users').doc(user.uid).set(updates, { merge: true });
                    }

                    alert('Perfil atualizado com sucesso!');
                    setTimeout(() => window.location.reload(), 1000);

                } catch (error) {
                    alert(`Erro: ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Salvar Altera√ß√µes';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                }
            });

            // Fun√ß√£o auxiliar para o upload da foto no Firebase Storage
            async function uploadUserPhoto(uid, file) {
                const storageRef = firebase.storage().ref(`users/${uid}/profile.jpg`);
                const snapshot = await storageRef.put(file);
                return await snapshot.ref.getDownloadURL();
            }
        });
    </script>

</body>

</html>