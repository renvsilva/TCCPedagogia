<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meu Perfil — Raquel Maciel Reis</title>

    <link rel="stylesheet" href="main.css">
    <link rel="icon" type="image/x-icon" href="Assets/Logo.jpg">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="nav" aria-label="Navegação principal">
        <div class="container nav-inner">
            <a class="brand" href="index.html" aria-label="Página inicial">
                <span class="logo" aria-hidden="true"><img src="Assets/Logo.jpg" class="logoimage" alt="Logo"></span>
                <span>
                    <h1>Raquel Maciel Reis</h1>
                    <small>Neuropsicopedagoga Clínica e Institucional</small>
                </span>
            </a>

            <div class="nav-menu" role="navigation">
                <a href="index.html#sobre">Sobre</a>
                <a href="index.html#servicos">Serviços</a>
                <a href="index.html#processo">Funcionamento</a>
                <a href="index.html#faq">Dúvidas</a>
                <a href="index.html#contato">Contato</a>
                <a id="admin-link" href="admin/dashboard.html" class="hidden">Admin</a>
                <div id="user-profile-container" class="hidden">
                    <img id="user-photo" src="Assets/Placeholder.jpg" alt="Foto do usuário" />
                    <span id="user-name-nav">Usuário</span>
                    <div id="profile-dropdown" class="hidden">
                        <a href="profile.html">Meu Perfil</a>
                        <a href="#" onclick="window.logoutUser(); return false;">Sair</a>
                    </div>
                </div>
                <a id="login-btn" class="cta" href="#">Login</a>
            </div>
        </div>
    </nav>

    <main class="container" style="padding-top: 40px; padding-bottom: 40px;">
        <section class="panel" style="max-width: 600px; margin: auto;">
            <h1>Meu Perfil</h1>
            <p class="muted">Atualize suas informações pessoais e de segurança.</p>

            <form id="perfilForm" class="form mt-4">
                <div class="profile-photo-section">
                    <img id="userPhotoPreview" src="Assets/Placeholder.jpg" alt="Prévia da foto de perfil">
                    <input type="file" id="photoUpload" accept="image/*">
                    <button type="button" id="uploadBtn" class="btn btn-ghost">Trocar Foto</button>
                </div>

                <label for="userName">Nome Completo:</label>
                <input type="text" id="userName" class="input" required>

                <label for="userEmail">E-mail:</label>
                <input type="email" id="userEmail" class="input" required>

                <hr style="border-color: var(--border); margin: 20px 0;">

                <p class="muted">Para alterar a senha, preencha os campos abaixo.</p>

                <label for="newPassword">Nova Senha:</label>
                <input type="password" id="newPassword" class="input" minlength="6"
                    placeholder="Deixe em branco para não alterar">

                <label for="confirmPassword">Confirmar Nova Senha:</label>
                <input type="password" id="confirmPassword" class="input" minlength="6">

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-storage-compat.js"></script>
    <script src="firebase.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const perfilForm = document.getElementById('perfilForm');
            const userNameInput = document.getElementById('userName');
            const userEmailInput = document.getElementById('userEmail');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const userPhotoPreview = document.getElementById('userPhotoPreview');
            const photoUploadInput = document.getElementById('photoUpload');
            const uploadBtn = document.getElementById('uploadBtn');

            // Lógica de upload de foto e redimensionamento (mantida)
            uploadBtn.addEventListener('click', () => photoUploadInput.click());

            function resizeAndConvertImage(file, maxWidth, maxHeight, quality) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = (error) => reject(error);
                    };
                    reader.onerror = (error) => reject(error);
                });
            }

            photoUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        alert('Por favor, selecione um arquivo de imagem.');
                        photoUploadInput.value = '';
                        return;
                    }
                    try {
                        const resizedBase64 = await resizeAndConvertImage(file, 400, 400, 0.8);
                        userPhotoPreview.src = resizedBase64;
                    } catch (error) {
                        console.error('Erro ao processar imagem:', error);
                        alert('Ocorreu um erro ao carregar a imagem.');
                        photoUploadInput.value = '';
                    }
                }
            });

            // Carrega as informações do usuário do Firestore assim que o estado de autenticação estiver pronto
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    try {
                        const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            userNameInput.value = userData.name || user.displayName || '';
                            userEmailInput.value = userData.email || user.email || '';
                            userPhotoPreview.src = userData.photoURL || user.photoURL || 'Assets/Placeholder.jpg';
                        } else {
                            userNameInput.value = user.displayName || '';
                            userEmailInput.value = user.email || '';
                            userPhotoPreview.src = user.photoURL || 'Assets/Placeholder.jpg';
                        }
                    } catch (error) {
                        console.error("Erro ao carregar dados do usuário:", error);
                        userNameInput.value = user.displayName || '';
                        userEmailInput.value = user.email || '';
                        userPhotoPreview.src = user.photoURL || 'Assets/Placeholder.jpg';
                    }
                } else {
                    alert("Você precisa estar logado para acessar esta página.");
                    window.location.href = 'index.html';
                }
            });

            // Lógica de submit do formulário (agora mais robusta)
            perfilForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = firebase.auth().currentUser;
                if (!user) return;

                const submitButton = perfilForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Salvando...';

                try {
                    const updates = {};
                    const fileToUpload = photoUploadInput.files[0];

                    // 1. Lógica de atualização da foto
                    if (fileToUpload) {
                        const newPhotoUrl = await uploadUserPhoto(user.uid, fileToUpload);
                        // Adiciona o novo URL da foto ao objeto de atualizações para o Firestore
                        updates.photoURL = newPhotoUrl;
                        // Atualiza também no Firebase Authentication
                        await user.updateProfile({ photoURL: newPhotoUrl });
                    }

                    // 2. Lógica de atualização de nome e email
                    if (userNameInput.value !== (user.displayName || '')) {
                        updates.name = userNameInput.value;
                        await user.updateProfile({ displayName: userNameInput.value });
                    }

                    if (userEmailInput.value !== (user.email || '')) {
                        updates.email = userEmailInput.value;
                        await user.updateEmail(userEmailInput.value);
                    }

                    // 3. Lógica de atualização da senha (separada das outras)
                    if (newPasswordInput.value) {
                        if (newPasswordInput.value !== confirmPasswordInput.value) {
                            throw new Error("As novas senhas não coincidem!");
                        }
                        await user.updatePassword(newPasswordInput.value);
                    }

                    // 4. Salva as informações atualizadas no Firestore (apenas se houver algo para salvar)
                    if (Object.keys(updates).length > 0) {
                        await firebase.firestore().collection('users').doc(user.uid).set(updates, { merge: true });
                    }

                    alert('Perfil atualizado com sucesso!');
                    setTimeout(() => window.location.reload(), 1000);

                } catch (error) {
                    alert(`Erro: ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Salvar Alterações';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                }
            });

            // Função auxiliar para o upload da foto no Firebase Storage
            async function uploadUserPhoto(uid, file) {
                const storageRef = firebase.storage().ref(`users/${uid}/profile.jpg`);
                const snapshot = await storageRef.put(file);
                return await snapshot.ref.getDownloadURL();
            }
        });
    </script>

</body>

</html>